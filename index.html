<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Baseball Game</title>
  <style>
    html, body {
      height: 100%;
      margin: 0;
      padding: 0;
    }

    body {
      background: #e3f2fd;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      font-family: sans-serif;
    }

    canvas {
      background: #4caf50;
      border: 3px solid #333;
    }

    button {
      margin-top: 20px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }

    #result {
      font-size: 32px;
      font-weight: bold;
      margin-top: 10px;
    }

    .pickoffBtn {
      display: none;
      position: absolute;
      font-size: 10px;         /* velikost textu */
      font-weight: bold;       /* tučný text */
      color: black;            /* barva textu */
      background-color: transparent; /* modré pozadí */
      border: 1px solid #005299; /* barva a tloušťka borderu */
      border-radius: 8px;      /* zaoblení rohů */
      padding: 3px 6px;       /* vnitřní odsazení */
      cursor: pointer;
      box-shadow: 2px 2px 5px rgba(0,0,0,0.3); /* jemný stín */
      transition: all .3s ease-in-out; /* animace při hoveru */
    }

    .pickoffBtn:hover {
      background-color: #005299; /* tmavší modrá při hoveru */
      color: white;
    }

    .pickoffBtn.active-pickoff {
      background-color: #005299; /* tmavší modrá */
      color: white;              /* bílý text */
    }
  </style>
</head>
<body>
  <!-- Kontejner pro hřiště a tlačítka -->
  <div id="gameContainer" style="position:relative; display:inline-block;">
    <canvas id="field" width="800" height="600"></canvas>

    <!-- Pickoff tlačítko – bude se přemisťovat pod 1. metu -->
    <button id="pickoffButton" class="pickoffBtn" tabindex="-1" style="display:none; position:absolute;">1B</button>
    <button id="pickoffButton2B" class="pickoffBtn" tabindex="-1" style="display:none; position:absolute;">2B</button>
  </div>

  <!-- Ostatní tlačítka a info pod hřištěm -->
  <br />
  <button id="throwButton" tabindex="-1">Ready</button><br />
  <div id="result"></div>
  <div id="countDisplay" style="font-size: 20px; font-weight: bold; margin-top: 5px;"></div>

  <script>
    const canvas = document.getElementById('field');
    const ctx = canvas.getContext('2d');
    const resultDisplay = document.getElementById('result');
    const throwButton = document.getElementById('throwButton');

    const centerX = canvas.width / 2;
    const homePlateY = canvas.height - 50;
    const baseDistance = 120;
    const playerSize = 20;

    // Obrázky hráčů
    const catcherImg = new Image();
    const nadhazovacImg = new Image();
    const palkarImg = new Image();
    const polarImg = new Image();
    const bezecImg = new Image();
    const ballImg = new Image();
    const batterDugoutImg = new Image();
    const benchPlayerImg = new Image();
    const slideImg = new Image();
    const actionImg = new Image();

    catcherImg.src = 'images/catcher.png';
    nadhazovacImg.src = 'images/nadhazovac.png';
    palkarImg.src = 'images/palkar.png';
    polarImg.src = 'images/polar.png';
    bezecImg.src = 'images/bezec.png';
    ballImg.src = 'images/baseball.png';
    batterDugoutImg.src = 'images/batterDugout.png';
    benchPlayerImg.src = 'images/benchPlayer.png';
    slideImg.src = 'images/slide.png';
    actionImg.src = 'images/akce.png';

    let battersQueue = [
      { name: 'Palkar1', img: palkarImg },
      { name: 'Palkar2', img: palkarImg },
      { name: 'Palkar3', img: palkarImg },
      { name: 'Palkar4', img: palkarImg },
      { name: 'Palkar5', img: palkarImg }
    ];

    // Posun v lineupu (strikeout, walk, hit, atd.)
    function nextBatter() {
      const batter = battersQueue.shift();   // sejmi aktuálního
      battersQueue.push(batter);             // vrať ho na konec
      return batter;                         // vrátí toho, kdo právě pálil
    }

    const players = [
      { name: 'Catcher', img: catcherImg, x: centerX - 10, y: homePlateY + 7 },
      { name: 'Nadhazovac', img: nadhazovacImg, x: centerX - 5, y: homePlateY - baseDistance - 5 },

      // Polaři (outfield + mezi základnami)
      { name: 'Polar_LeftField', img: polarImg, x: centerX - 170, y: homePlateY - 300 },        // Left Field
      { name: 'Polar_CenterField', img: polarImg, x: centerX - 20,  y: homePlateY - 350 },       // Center Field
      { name: 'Polar_RightField', img: polarImg, x: centerX + 130, y: homePlateY - 300 },        // Right Field

      { name: 'Polar_SecondBase', img: polarImg, x: centerX + baseDistance / 4, y: homePlateY - baseDistance - 120}, // Mezi 1 a 2
      { name: 'Polar_ShortStop', img: polarImg, x: centerX - baseDistance / 2, y: homePlateY - baseDistance * 2 }, // Mezi 2 a 3

      { name: 'Polar_ThirdBase', img: polarImg, x: centerX - baseDistance - 0, y: homePlateY - baseDistance - 50 }, // Blízko 3
      { name: 'Polar_FirstBase', img: polarImg, x: centerX + baseDistance - 30, y: homePlateY - baseDistance - 50 }  // Blízko 1
    ];

    // Konstantní souřadnice met (musí být konzistentní s draw())
    const POS = {
      FIRST: { x: centerX + baseDistance - playerSize / 2, y: homePlateY - baseDistance - playerSize / 2 },
      SECOND: { x: centerX - playerSize / 2, y: homePlateY - baseDistance * 2 - playerSize / 2 },
      THIRD: { x: centerX - baseDistance - playerSize / 2, y: homePlateY - baseDistance - playerSize / 2 },
      HOME: { x: centerX, y: homePlateY },
    };

    // Funkce pro pozice pálkaře a on-deck
    function getBatterPositions() {
      return [
        {
          ...battersQueue[0],
          x: centerX - 37,
          y: homePlateY - 15
        },
        {
          ...battersQueue[1],
          x: centerX + 90 - playerSize/2,
          y: homePlateY - 5 - playerSize/2
        }
      ];
    }

    function strikeOut() {
      if (battersQueue.length > 0) {
        const batterOut = nextBatter(); // aktuální šel pálit a jde pryč

        // do dugoutu
        startBatterToDugout(batterOut, 'right');
        hideBatterDuringOnDeckAnimation = true;

        // nový pálkař = teď na začátku fronty
        const newBatter = battersQueue[0];
        const nextOnDeck = battersQueue.length > 1 ? battersQueue[1] : null;

        if (nextOnDeck) {
          sendBatterFromDugoutToOnDeck(nextOnDeck, 'right');
        }

        if (newBatter) {
          sendBatterFromOnDeck(newBatter, 'right', () => {
            hideBatterDuringOnDeckAnimation = false;
            resetCount();
          });
        } else {
          hideBatterDuringOnDeckAnimation = false;
          resetCount();
        }
      }
      draw();
    }

    function ballFour() {
      if (battersQueue.length > 0) {
        // aktuální pálkař = walk
        const batterOut = nextBatter(); 
        const newRunner = { name: batterOut.name, img: bezecImg };

        // běžec na 1B
        animateRunnerToFirstBase(newRunner);

        // nový pálkař = teď na začátku fronty
        const newBatter = battersQueue[0];
        const nextOnDeck = battersQueue.length > 1 ? battersQueue[1] : null;

        if (nextOnDeck) {
          sendBatterFromDugoutToOnDeck(nextOnDeck, 'right');
        }

        if (newBatter) {
          sendBatterFromOnDeck(newBatter, 'right', () => {
            resetCount();
            draw();
          });
        } else {
          resetCount();
          draw();
        }
      }
      draw();
    }

    const ball = {
      active: false,
      x: 0,
      y: 0,
      startX: 0,
      startY: 0,
      endX: 0,
      endY: 0,
      progress: 0,
      owner: "pitcher"
    };

    const slider = {
      active: false,
      x: canvas.width / 2 - 150,
      y: 20, // nahoře uprostřed canvasu
      width: 300,
      height: 20,
      handleX: canvas.width / 2 - 150,
      speed: 2,
      stopped: false,
      result: null // "BALL" | "STRIKE"
    };

    function drawSlider() {
      if (!slider.active) return;

      const total = slider.width;
      const gray1 = total * 0.5;
      const blue = total * 0.3;
      const green = total * 0.15;
      const gray2 = total * 0.05;

      let offset = slider.x;
      ctx.fillStyle = 'gray';
      ctx.fillRect(offset, slider.y, gray1, slider.height);

      offset += gray1;
      ctx.fillStyle = 'blue';
      ctx.fillRect(offset, slider.y, blue, slider.height);

      offset += blue;
      ctx.fillStyle = 'green';
      ctx.fillRect(offset, slider.y, green, slider.height);

      offset += green;
      ctx.fillStyle = 'gray';
      ctx.fillRect(offset, slider.y, gray2, slider.height);

      ctx.fillStyle = 'black';
      ctx.fillRect(slider.handleX - 2, slider.y, 4, slider.height);
    }

    function updateSlider() {
      if (!slider.active || slider.stopped) return;
      slider.handleX += slider.speed;

      if (slider.handleX > slider.x + slider.width) {
        slider.stopped = true;
        slider.result = 'BALL';
        resultDisplay.textContent = slider.result;
        resultDisplay.style.color = 'red';
        ballCount++;
        updateCountDisplay();

        const pitcher = players.find(p => p.name === 'Nadhazovac');
        const catcher = players.find(p => p.name === 'Catcher');
        ball.startX = pitcher.x + playerSize / 2;
        ball.startY = pitcher.y + playerSize / 2;
        ball.endX = catcher.x + playerSize / 2 + 60;
        ball.endY = catcher.y + playerSize / 2 + 40;
        ball.x = ball.startX;
        ball.y = ball.startY;
        ball.progress = 0;
        ball.active = true;
        draw();
        animateBall(() => {
          ball.owner = "catcher"; // míč chytil catcher

          // pokud není strikeout ani ball four, catcher vrátí míč zpět
          if (strikeCount < 3 && ballCount < 4) {
            setTimeout(() => returnBallToPitcher(), 800);
          }
        });

        ballCountInProgress = true;

        const waitForBall = setInterval(() => {
          if (!ball.active) {
            clearInterval(waitForBall);
            ballCountInProgress = false;

            // BALL FOUR -> spustit animaci běžců správně
            if (ballCount >= 4 && battersQueue.length > 0) {
              resultDisplay.textContent = 'BALL FOUR';
              resultDisplay.style.color = 'red';
              ballFour();   // <<< zavoláme stejnou funkci jako u normálního BALL FOUR
              resetCount();
            }
          }
        }, 50);
      }
    }
        
    function evaluatePitch() {
      const total = slider.width;
      const gray1 = total * 0.5;
      const blue = total * 0.3;
      const green = total * 0.15;
      const gray2 = total * 0.05;

      const pos = slider.handleX - slider.x;

      if (pos < gray1) return 'BALL';
      else if (pos < gray1 + blue) return Math.random() < 0.5 ? 'BALL' : 'STRIKE';
      else if (pos < gray1 + blue + green) return 'STRIKE';
      else return 'BALL';
    }

    let strikeCount = 0;
    let ballCount = 0;

    function updateCountDisplay() {
      const display = document.getElementById('countDisplay');
      const batterName = battersQueue.length > 0 ? battersQueue[0].name : "No batter";
      display.textContent = `Balls: ${ballCount} | Strikes: ${strikeCount} | Now batting: ${batterName}`;
    }

    updateCountDisplay();

    function resetCount() {
      strikeCount = 0;
      ballCount = 0;
      updateCountDisplay();
    }

    document.addEventListener('keydown', (e) => {
      if (e.code === 'Space' && slider.active && !slider.stopped) {
        slider.stopped = true;
        slider.result = evaluatePitch();
        resultDisplay.textContent = slider.result;
        resultDisplay.style.color = slider.result === 'STRIKE' ? 'green' : 'red';

        if (slider.result === 'STRIKE') strikeCount++;
        if (slider.result === 'BALL') {
          ballCount++;
        }
        updateCountDisplay();

        let delay = 500;

        if (strikeCount >= 3) {
          resultDisplay.textContent = 'STRIKEOUT';
          resultDisplay.style.color = 'green';
          delay = 1000;
        } else if (ballCount >= 4) {
          resultDisplay.textContent = 'BALL FOUR';
          resultDisplay.style.color = 'red';
          delay = 1000;
        }

        setTimeout(() => {
          const pitcher = players.find(p => p.name === 'Nadhazovac');
          const catcher = players.find(p => p.name === 'Catcher');
          ball.startX = pitcher.x + playerSize / 2;
          ball.startY = pitcher.y + playerSize / 2;
          ball.endX = catcher.x + playerSize / 2 + (slider.result === 'BALL' ? 60 : 0);
          ball.endY = catcher.y + playerSize / 2 + (slider.result === 'BALL' ? 40 : 0);
          ball.x = ball.startX;
          ball.y = ball.startY;
          ball.progress = 0;
          ball.active = true;
          slider.active = false;
          draw();
          animateBall(() => {
            ball.owner = "catcher"; // míč chytil catcher

            // pokud není strikeout ani ball four, catcher vrátí míč zpět
            if (strikeCount < 3 && ballCount < 4) {
              setTimeout(() => returnBallToPitcher(), 800);
            }
          });

          const waitForBallDone = setInterval(() => {
            if (!ball.active) {
              clearInterval(waitForBallDone);
              ballCountInProgress = false;

              // STRIKEOUT -> animace do dugoutu + posun fronty
              if (strikeCount >= 3) {
                sendPlayerToDugout('right');
                strikeOut();
                resetCount();
              }

              // BALL FOUR -> walk animace + POSUN FRONTY
              if (ballCount >= 4) {
                ballFour();          // <<< přidáno: fronta stejně jako u strikeout
              }

              // reset counts
              if (ballCount >= 4) resetCount();
              if (strikeCount >= 3 && !batterRunningToDugout) {
                resetCount();
              }
            }
          }, 50);
        }, delay);
      }
    });

    function drawBall() {
      if (ball.active && ballImg.complete) {
        ctx.drawImage(ballImg, ball.x - 5, ball.y - 5, 10, 10);
      }
    }

    function animateBall(onComplete) {
      if (!ball.active) return;

      ball.progress += 0.01;
      if (ball.progress >= 1) {
        ball.active = false;
        draw();
        if (typeof onComplete === 'function') onComplete();
        return;
      }

      ball.x = ball.startX + (ball.endX - ball.startX) * ball.progress;
      ball.y = ball.startY + (ball.endY - ball.startY) * ball.progress;
      draw();
      requestAnimationFrame(() => animateBall(onComplete));
    }
    
    // Funkce pro návrat míče zpět k nadhazovači
    function returnBallToPitcher() {
      const pitcher = players.find(p => p.name === "Nadhazovac");
      let ownerX, ownerY;

      if (ball.owner === "catcher") {
        const catcher = players.find(p => p.name === "Catcher");
        ownerX = catcher.x + playerSize / 2;
        ownerY = catcher.y + playerSize / 2;
      } else if (ball.owner === "polar") {
        const polar = players.find(p => p.name === "Polar_SecondBase");
        ownerX = polar.x + playerSize / 2;
        ownerY = polar.y + playerSize / 2;
      } else if (ball.owner === "firstBase") {
        const base = POS.FIRST;
        ownerX = base.x + playerSize / 2;
        ownerY = base.y + playerSize / 2;
      } else {
        // fallback (kde míč skončil)
        ownerX = ball.x;
        ownerY = ball.y;
      }

      ball.startX = ownerX;
      ball.startY = ownerY;
      ball.endX = pitcher.x + playerSize / 2;
      ball.endY = pitcher.y + playerSize / 2;
      ball.x = ball.startX;
      ball.y = ball.startY;
      ball.progress = 0;
      ball.active = true;

      animateBall(() => {
        ball.owner = "pitcher"; // zpět u nadhazovače
      });
    }
    
    let pickoffAttempt1B = false;
    let pickoffAttempt2B = false;

    const pickoffBtn1B = document.getElementById("pickoffButton");
    const pickoffBtn2B = document.getElementById("pickoffButton2B");

    // Kliknutí na 1B
    pickoffBtn1B.addEventListener("click", () => {
      pickoffAttempt1B = !pickoffAttempt1B;
      pickoffBtn1B.classList.toggle("active-pickoff", pickoffAttempt1B);
      pickoffAttempt2B = false;
      pickoffBtn2B.classList.remove("active-pickoff");
    });

    // Kliknutí na 2B
    pickoffBtn2B.addEventListener("click", () => {
      pickoffAttempt2B = !pickoffAttempt2B;
      pickoffBtn2B.classList.toggle("active-pickoff", pickoffAttempt2B);
      pickoffAttempt1B = false;
      pickoffBtn1B.classList.remove("active-pickoff");
    });

    throwButton.addEventListener('click', () => {
      throwButton.blur();

      if (pickoffAttempt1B) {
        startPickoff1B();
        pickoffAttempt1B = false;
        pickoffBtn1B.classList.remove("active-pickoff");
      } else if (pickoffAttempt2B) {
        startPickoff2B();
        pickoffAttempt2B = false;
        pickoffBtn2B.classList.remove("active-pickoff");
      } else {
        // původní logika slideru
        slider.active = true;
        slider.stopped = false;
        slider.result = null;
        slider.handleX = slider.x;
        resultDisplay.textContent = '';
        draw();
      }
    });

    function startPickoff1B() {
      const pitcher = players.find(p => p.name === "Nadhazovac");
      const firstBase = POS.FIRST;

      // CÍL = STŘED 1. METY
      const baseCenterX = firstBase.x + playerSize / 2;
      const baseCenterY = firstBase.y + playerSize / 2;

      ball.startX = pitcher.x + playerSize / 2;
      ball.startY = pitcher.y + playerSize / 2;
      ball.endX = baseCenterX;
      ball.endY = baseCenterY;
      ball.x = ball.startX;
      ball.y = ball.startY;
      ball.progress = 0;
      ball.active = true;

      draw();

      if (runnerOnFirstBase) {
        moveRunnerBackToBaseAndLead(runnerOnFirstBase, POS.FIRST);
      }

      animateBall(() => {
        resultDisplay.textContent = "SAFE!";
        resultDisplay.style.color = "green";
        ball.owner = "firstBase"; // míč má hráč na 1B
        draw();

        setTimeout(() => returnBallToPitcher(), 500);
      });
    }

    function startPickoff2B() {
      const pitcher = players.find(p => p.name === "Nadhazovac");
      const secondBase = POS.SECOND;
      const polar = players.find(p => p.name === "Polar_SecondBase");

      // uložíme původní pozici Polara
      if (polar) {
        polar.originalX = polar.x;
        polar.originalY = polar.y;
        polar.defaultImg = polar.img; 
      }

      // CÍL = STŘED 2. METY
      const baseCenterX = secondBase.x + playerSize / 2;
      const baseCenterY = secondBase.y + playerSize / 2;

      ball.startX = pitcher.x + playerSize / 2;
      ball.startY = pitcher.y + playerSize / 2;
      ball.endX = baseCenterX;
      ball.endY = baseCenterY;
      ball.x = ball.startX;
      ball.y = ball.startY;
      ball.progress = 0;
      ball.active = true;

      draw();

      if (runnerOnSecondBase) {
        moveRunnerBackToBaseAndLead(runnerOnSecondBase, POS.SECOND);
      }

      // animace Polara směrem k metě
      if (polar) {
        animatePolarToSecond(polar, secondBase, () => {
          // až doběhne → čeká u mety, dokud neskončí pickoff
        });
      }

      animateBall(() => {
        resultDisplay.textContent = "SAFE!";
        resultDisplay.style.color = "green";
        ball.owner = "polar";

        // návrat Polara zpět na původní pozici
        if (polar) {
          setTimeout(() => {
            animatePolarBack(polar);
          }, 500);
        }

        setTimeout(() => returnBallToPitcher(), 500);

        draw();
      });
    }

    function animatePolarToSecond(polar, base, onComplete) {
      const startX = polar.x;
      const startY = polar.y;
      const targetX = base.x + 5;  // posun aby to vypadalo jako tag
      const targetY = base.y - 5;
      const duration = 500; // 0.5 s (stejně jako míč)

      polar.img = actionImg;
      polar.state = "runningToBase"; // <<<<< sem přidáme stav

      const startTime = performance.now();

      function animate(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);

        polar.x = startX + (targetX - startX) * progress;
        polar.y = startY + (targetY - startY) * progress;

        draw();

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // stojí na metě → zpět na defaultImg
          polar.img = polar.defaultImg;
          polar.state = "tagging"; // stojí u mety
          draw();

          if (onComplete) onComplete();
        }
      }

      requestAnimationFrame(animate);
    }

    function animatePolarBack(polar) {
      const startX = polar.x;
      const startY = polar.y;
      const targetX = polar.originalX;
      const targetY = polar.originalY;
      const duration = 500;

      polar.img = actionImg; // zase akce když běží zpět

      const startTime = performance.now();

      function animate(time) {
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);

        polar.x = startX + (targetX - startX) * progress;
        polar.y = startY + (targetY - startY) * progress;

        draw();

        if (progress < 1) {
          requestAnimationFrame(animate);
        } else {
          // když dorazí zpět → defaultní fotka
          polar.img = polar.defaultImg;
          draw();
        }
      }

      requestAnimationFrame(animate);
    }

    function moveRunnerBackToBaseAndLead(runner, basePos) {
      if (!runner) return;

      const BASE = basePos;
      const LEAD_OFFSET = 25;
      const duration = 500; // 0.5s

      // STŘED METY (POZOR: POS.* jsou levé-horní rohy)
      const baseCenterX = BASE.x + playerSize / 2;
      const baseCenterY = BASE.y + playerSize / 2;

      // Výchozí lead (musí 1:1 odpovídat tomu, co dělá drawRun, když runner.x/y jsou undefined)
      let defaultLeadX = baseCenterX;
      let defaultLeadY = baseCenterY;

      if (BASE === POS.FIRST) {         // v drawRun: -x, -y
        defaultLeadX -= LEAD_OFFSET;
        defaultLeadY -= LEAD_OFFSET;
      } else if (BASE === POS.SECOND) { // v drawRun: -x, +y
        defaultLeadX -= LEAD_OFFSET;
        defaultLeadY += LEAD_OFFSET;
      } else if (BASE === POS.THIRD) {  // v drawRun: +x, +y
        defaultLeadX += LEAD_OFFSET;
        defaultLeadY += LEAD_OFFSET;
      }

      // Start animace = aktuální viditelná pozice (pokud už má runner.x/y),
      // jinak přesně ta defaultní lead pozice, jak ji vykreslí drawRun.
      const leadX = (runner.x !== undefined) ? runner.x : defaultLeadX;
      const leadY = (runner.y !== undefined) ? runner.y : defaultLeadY;

      // runner je ve "slidu"
      runner.state = "sliding";

      // FÁZE 1 – na metu (na její STŘED)
      function animateToBase(time, startTime = null) {
        if (!startTime) startTime = time;
        const elapsed = time - startTime;
        const progress = Math.min(elapsed / duration, 1);

        runner.x = leadX + (baseCenterX - leadX) * progress;
        runner.y = leadY + (baseCenterY - leadY) * progress;

        draw();

        if (progress < 1) {
          requestAnimationFrame(t => animateToBase(t, startTime));
        } else {
          // přesně střed mety
          runner.x = baseCenterX;
          runner.y = baseCenterY;
          resultDisplay.textContent = "SAFE!";
          resultDisplay.style.color = "green";
          draw();

          // FÁZE 2 – zpět do leadu (pomalý návrat)
          setTimeout(() => {
            runner.state = "returning";
            animateBackToLead(runner, defaultLeadX, defaultLeadY);
          }, 500);
        }
      }

      // FÁZE 2 – návrat do leadu (použijeme zase středy)
      function animateBackToLead(runner, targetX, targetY) {
        const startX = runner.x;
        const startY = runner.y;
        const startTime = performance.now();

        function animate(time) {
          const elapsed = time - startTime;
          const progress = Math.min(elapsed / duration, 1);

          runner.x = startX + (targetX - startX) * progress;
          runner.y = startY + (targetY - startY) * progress;

          draw();

          if (progress < 1) {
            requestAnimationFrame(animate);
          } else {
            // vrátíme zodpovědnost na drawRun (bez ruční pozice)
            runner.x = undefined;
            runner.y = undefined;
            runner.state = "lead";
            draw();
          }
        }

        requestAnimationFrame(animate);
      }

      requestAnimationFrame(animateToBase);
    }

    function gameLoop() {
      updateSlider();
      updateDugoutRunners();
      draw();
      requestAnimationFrame(gameLoop);
    }

    let runnerOnFirstBase = null;
    let ballCountInProgress = false;
    let runnerOnSecondBase = null;
    let runnerOnThirdBase = null;

    let hideOnDeckDuringAnimation = false;
    let currentOnDeckBatter = battersQueue[1]; // sem si ukládáš, kdo tam má stát

    let teamBScore = 0;
    let runScoredText = '';
    let runScoredTimeout = null;
    let hideBatterDuringOnDeckAnimation = false;
    let runnersInMotion = false;

    let dugoutLeftPos = null;
    let dugoutRightPos = null;

    let dugoutRunners = [];

    let batterRunningToDugout = false;
    let batterRunObj = null;

    function drawRunScored() {
      if (runScoredText) {
        ctx.font = 'bold 32px sans-serif';
        ctx.fillStyle = 'yellow';
        ctx.textAlign = 'center';
        ctx.fillText(runScoredText, centerX, homePlateY - 250);
      }
    }

    function incrementTeamBScore(scoringRunner) {
      teamBScore++;
      runScoredText = 'RUN SCORED!';
      // pošli hráče do dugoutu i s obrázkem a jménem
      if (scoringRunner) {
        startBatterToDugout(scoringRunner, 'right');
      }
      clearTimeout(runScoredTimeout);
      runScoredTimeout = setTimeout(() => {
        runScoredText = '';
      }, 2000);
    }

    // >>> NOVÉ: animace běžců při postupu na první metu (walk, hit, atd.)
    function animateRunnerToFirstBase(newRunner) {
      runnersInMotion = true;
      const runners = [];

      // 3B -> DOMŮ
      if (runnerOnThirdBase) {
        runners.push({
          from: { ...POS.THIRD },
          to: { ...POS.HOME },
          player: runnerOnThirdBase, // už je to běžec-objekt
          update: () => {
            const scoringRunner = runnerOnThirdBase; // uložíme odkaz na hráče
            runnerOnThirdBase = null;
            incrementTeamBScore(scoringRunner);
          }
        });
      }

      // 2B -> 3B
      if (runnerOnSecondBase) {
        runners.push({
          from: { ...POS.SECOND },
          to: { ...POS.THIRD },
          player: runnerOnSecondBase,
          update: () => {
            runnerOnThirdBase = runnerOnSecondBase;
            runnerOnSecondBase = null;
          }
        });
      }

      // 1B -> 2B
      if (runnerOnFirstBase) {
        runners.push({
          from: { ...POS.FIRST },
          to: { ...POS.SECOND },
          player: runnerOnFirstBase,
          update: () => {
            runnerOnSecondBase = runnerOnFirstBase;
            runnerOnFirstBase = null;
          }
        });
      }

      // NOVÝ BĚŽEC: HOME -> 1B (vytvořen už jako { name, img: bezecImg })
      runners.push({
        from: { ...POS.HOME },
        to: { ...POS.FIRST },
        player: newRunner,
        update: () => {
          runnerOnFirstBase = newRunner; // na metách se drží jen "běžec" objekt
        }
      });

      runners.forEach(r => r.progress = 0);

      function drawRunners() {
        let allDone = true;
        draw();

        runners.forEach(runner => {
          if (runner.progress < 1) {
            runner.progress += 1 / (60 * 7.5);
            const x = runner.from.x + (runner.to.x - runner.from.x) * runner.progress;
            const y = runner.from.y + (runner.to.y - runner.from.y) * runner.progress;


            // běžec má vždy img = bezecImg (nikdy nepoužij pálkaře)
            const sprite = runner.player && runner.player.img ? runner.player.img : bezecImg;

            // --- VÝPOČET ÚHLU PODLE SMĚRU POHYBU ---
            const dx = runner.to.x - runner.from.x;
            const dy = runner.to.y - runner.from.y;
            const angle = Math.atan2(dy, dx);

            ctx.save();
            ctx.translate(x + playerSize / 2, y + playerSize / 2); // střed obrázku
            ctx.rotate(angle);
            ctx.drawImage(sprite, -playerSize / 2, -playerSize / 2, playerSize, playerSize);
            ctx.restore();

            // jméno nad běžcem
            if (runner.player && runner.player.name) {
              ctx.font = "12px Arial";
              ctx.fillStyle = "black";
              ctx.textAlign = "center";
              ctx.fillText(runner.player.name, x + playerSize / 2, y - 5);
            }

            allDone = false;
          } else if (runner.progress >= 1 && typeof runner.update === 'function') {
            runner.update();
            runner.update = null;
          }
        });

        if (!allDone) {
          requestAnimationFrame(drawRunners);
        } else {
          runnersInMotion = false;
          draw();
        }
      }
      drawRunners();
    }
    
    // === sjednocené poslání hráče do dugoutu ===
    function sendPlayerToDugout(side = 'left', player = null, onArrive = null) {
      const home = { x: centerX, y: homePlateY };
      const offset = 80;
      let targetX, targetY;

      if (side === 'left') {
        const angleLeft = Math.PI * 1.25;
        targetX = home.x + Math.cos(angleLeft) * 3 * offset;
        targetY = home.y + Math.sin(angleLeft) * 1.5 * offset;
      } else {
        const angleRight = Math.PI * 1.75;
        targetX = home.x + Math.cos(angleRight) * 2 * offset;
        targetY = home.y + Math.sin(angleRight) * 0.5 * offset;
      }

      dugoutRunners.push({
        x: home.x,
        y: home.y,
        targetX,
        targetY,
        speed: 0.26,
        color: side === 'left' ? '#1565c0' : '#c62828',
        player: player ? { name: player.name, img: player.img || palkarImg } : null,
        onArrive: typeof onArrive === 'function' ? onArrive : null
      });
    }

    function updateDugoutRunners() {
      for (let i = dugoutRunners.length - 1; i >= 0; i--) {
        const runner = dugoutRunners[i];
        const dx = runner.targetX - runner.x;
        const dy = runner.targetY - runner.y;
        const dist = Math.sqrt(dx * dx + dy * dy);

        if (dist < runner.speed) {
          if (runner.onArrive) {
            try { runner.onArrive(runner); } catch (e) {}
          }
          dugoutRunners.splice(i, 1);
        } else {
          runner.x += (dx / dist) * runner.speed;
          runner.y += (dy / dist) * runner.speed;
        }
      }
    }

    function drawDugoutRunners() {
      dugoutRunners.forEach(runner => {
        if (runner.player && runner.player.img) {
          const img = runner.player.img;
          if (img.complete) {
            ctx.drawImage(img, runner.x - playerSize / 2, runner.y - playerSize / 2, playerSize, playerSize);
          } else {
            ctx.beginPath();
            ctx.arc(runner.x, runner.y, playerSize / 2, 0, Math.PI * 2);
            ctx.fillStyle = runner.color || 'blue';
            ctx.fill();
          }

          if (runner.player.name) {
            ctx.font = "12px Arial";
            ctx.fillStyle = "black";
            ctx.textAlign = "center";
            ctx.fillText(runner.player.name, runner.x, runner.y - playerSize / 2 - 5);
          }
        } 
      });
    }

    // === wrapper: konkrétní pálkař do dugoutu ===
    function startBatterToDugout(outBatter, side = 'right') {
      if (!outBatter) return;

      const runnerPlayer = {
        name: outBatter.name || "???",
        img: batterDugoutImg || palkarImg
      };

      // pálkař se hýbe rychleji než běžný runner
      sendPlayerToDugout(side, runnerPlayer, 3.0);
    }   

    // === NOVÉ: pálkař z on-deck kruhu do boxu ===
    function sendBatterFromOnDeck(newBatter, side = 'right', onArrive = null) {
      const home = { x: centerX, y: homePlateY };
      const offsetX = 90;
      const offsetY = 5;

      // souřadnice z drawOnDeckCircle
      const onDeck = side === 'right'
        ? { x: centerX + offsetX, y: homePlateY - offsetY }
        : { x: centerX - offsetX, y: homePlateY - offsetY };

      hideBatterDuringOnDeckAnimation = true;

      dugoutRunners.push({
        x: onDeck.x,
        y: onDeck.y,
        targetX: home.x,
        targetY: home.y,
        speed: 0.20, // rychlost animace – můžeš zrychlit/zpomalit
        color: side === 'left' ? '#1565c0' : '#c62828',
        player: { name: newBatter.name, img: batterDugoutImg || palkarImg },
        onArrive: () => {
          hideBatterDuringOnDeckAnimation = false; // <<< zobraz až po příchodu
          if (typeof onArrive === 'function') onArrive();
        }
      });
    }

    // === NOVÉ: pálkař z dugoutu do on-deck kruhu ===
    function sendBatterFromDugoutToOnDeck(newBatter, side = 'right', onArrive = null) {
      const home = { x: centerX, y: homePlateY };
      const offset = 80;   // stejné jako u sendPlayerToDugout
      const offsetX = 90;  // stejné jako v drawOnDeckCircle
      const offsetY = 5;

      // výpočet pozice dugoutu (stejná logika jako v sendPlayerToDugout)
      let dugoutX, dugoutY;
      if (side === 'left') {
        const angleLeft = Math.PI * 1.25;
        dugoutX = home.x + Math.cos(angleLeft) * 3 * offset;
        dugoutY = home.y + Math.sin(angleLeft) * 1.5 * offset;
      } else {
        const angleRight = Math.PI * 1.75;
        dugoutX = home.x + Math.cos(angleRight) * 2 * offset;
        dugoutY = home.y + Math.sin(angleRight) * 0.5 * offset;
      }

      // cíl = souřadnice on-deck kruhu
      const onDeck = side === 'right'
        ? { x: centerX + offsetX, y: homePlateY - offsetY }
        : { x: centerX - offsetX, y: homePlateY - offsetY };

      // <<< skryj hráče v kruhu, dokud animace neskončí
      hideOnDeckDuringAnimation = true;
      currentOnDeckBatter = null; // <<< smažeme starého hráče
            
      dugoutRunners.push({
        x: dugoutX,
        y: dugoutY,
        targetX: onDeck.x,
        targetY: onDeck.y,
        speed: 0.072, // můžeš zrychlit/zpomalit
        color: side === 'left' ? '#1565c0' : '#c62828',
        player: { 
          name: newBatter.name, 
          img: batterDugoutImg || palkarImg  // může mít jiný obrázek než v boxu
        },
        onArrive: () => {
          // <<< až teď se objeví v on-deck kruhu
          hideOnDeckDuringAnimation = false;
          currentOnDeckBatter = newBatter;

          if (typeof onArrive === 'function') onArrive();
        }
      });
    }
    
    // Pomocné funkce pro hřiště (nejsou měněny z původního kódu)
    function drawDiamond() {
      const home = { x: centerX, y: homePlateY };
      const first = { x: home.x + baseDistance, y: home.y - baseDistance };
      const second = { x: home.x, y: home.y - baseDistance * 2 };
      const third = { x: home.x - baseDistance, y: home.y - baseDistance };

      ctx.beginPath();
      ctx.moveTo(home.x, home.y);
      ctx.lineTo(first.x, first.y);
      ctx.lineTo(second.x, second.y);
      ctx.lineTo(third.x, third.y);
      ctx.closePath();
      ctx.fillStyle = '#ffcc80';
      ctx.fill();
      ctx.stroke();

      const baseSize = 15;
      [first, second, third].forEach(base => {
        ctx.save();
        ctx.translate(base.x, base.y);
        ctx.rotate(Math.PI / 4);
        ctx.fillStyle = 'white';
        ctx.fillRect(-baseSize / 2, -baseSize / 2, baseSize, baseSize);
        ctx.restore();
      });

      drawHomePlate(home.x, home.y, baseSize);

      // Mound
      ctx.beginPath();
      ctx.arc(centerX, home.y - baseDistance, 15, 0, Math.PI * 2);
      ctx.fillStyle = '#a1887f';
      ctx.fill();

      const moundX = centerX - 7.5;
      const moundY = home.y - baseDistance - 2.5;
      const moundWidth = 15;
      const moundHeight = 3.5;

      ctx.fillStyle = 'white';
      ctx.fillRect(moundX, moundY, moundWidth, moundHeight);
      ctx.strokeRect(moundX, moundY, moundWidth, moundHeight);
    }

    function drawHomePlate(x, y, size) {
      const half = size / 2;
      const height = size * 0.75;

      ctx.beginPath();
      ctx.moveTo(x - half, y - height);
      ctx.lineTo(x + half, y - height);
      ctx.lineTo(x + half, y);
      ctx.lineTo(x, y + height / 2);
      ctx.lineTo(x - half, y);
      ctx.closePath();
      ctx.fillStyle = 'white';
      ctx.fill();
      ctx.stroke();
    }

    function drawFoulLines() {
      const home = { x: centerX, y: homePlateY };
      const foulRadius = 400;
      const leftAngle = Math.PI * 1.25;
      const rightAngle = Math.PI * 1.75;

      const leftFoulX = home.x + Math.cos(leftAngle) * foulRadius;
      const leftFoulY = home.y + Math.sin(leftAngle) * foulRadius;

      const rightFoulX = home.x + Math.cos(rightAngle) * foulRadius;
      const rightFoulY = home.y + Math.sin(rightAngle) * foulRadius;

      ctx.beginPath();
      ctx.moveTo(home.x, home.y);
      ctx.lineTo(leftFoulX, leftFoulY);
      ctx.moveTo(home.x, home.y);
      ctx.lineTo(rightFoulX, rightFoulY);
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function drawOutfield() {
      const home = { x: centerX, y: homePlateY };
      ctx.beginPath();
      ctx.moveTo(home.x, home.y);
      ctx.arc(home.x, home.y, 400, -Math.PI * 0.25, -Math.PI * 0.75, true);
      ctx.closePath();
      ctx.fillStyle = '#66bb6a';
      ctx.fill();
      ctx.stroke();
    }

    function drawWarningTrack() {
      const home = { x: centerX, y: homePlateY };
      const outerRadius = 400;
      const trackWidth = 15;

      ctx.beginPath();
      ctx.arc(home.x, home.y, outerRadius, -Math.PI * 0.25, -Math.PI * 0.75, true);
      ctx.arc(home.x, home.y, outerRadius - trackWidth, -Math.PI * 0.75, -Math.PI * 0.25, false);
      ctx.closePath();
      ctx.fillStyle = '#ffcc80';
      ctx.fill();
    }

    function drawTabula() {
      const home = { x: centerX, y: homePlateY };
      const plotRadius = 400;
      const tabulaDepth = 10;
      const tabulaWidth = 110;
      const tabulaHeight = 80;
      const angle = -Math.PI / 2;

      const tabulaX = home.x + Math.cos(angle) * (plotRadius + tabulaDepth);
      const tabulaY = home.y + Math.sin(angle) * (plotRadius + tabulaDepth);

      ctx.save();
      ctx.translate(tabulaX, tabulaY);

      ctx.strokeStyle = '#555a5f';
      ctx.lineWidth = 6;
      const poleHeight = 11;
      const poleOffsetX = tabulaWidth / 2 - 20;

      ctx.beginPath();
      ctx.moveTo(-poleOffsetX, 0);
      ctx.lineTo(-poleOffsetX, poleHeight);
      ctx.moveTo(poleOffsetX, 0);
      ctx.lineTo(poleOffsetX, poleHeight);
      ctx.stroke();

      const grad = ctx.createLinearGradient(-tabulaWidth/2, -tabulaHeight, tabulaWidth/2, 0);
      grad.addColorStop(0, '#d0d4d8');
      grad.addColorStop(0.5, '#8c8f92');
      grad.addColorStop(1, '#d0d4d8');

      ctx.fillStyle = grad;
      ctx.fillRect(-tabulaWidth / 2, -tabulaHeight, tabulaWidth, tabulaHeight);

      ctx.fillStyle = 'rgba(255, 255, 255, 0.3)';
      ctx.beginPath();
      ctx.moveTo(-tabulaWidth / 2, -tabulaHeight);
      ctx.lineTo(-tabulaWidth / 2 + 30, -tabulaHeight);
      ctx.lineTo(tabulaWidth / 2, 0);
      ctx.lineTo(tabulaWidth / 2 - 30, 0);
      ctx.closePath();
      ctx.fill();

      ctx.strokeStyle = '#666a6f';
      ctx.lineWidth = 2;
      ctx.strokeRect(-tabulaWidth / 2, -tabulaHeight, tabulaWidth, tabulaHeight);

      ctx.fillStyle = '#222';
      ctx.textBaseline = 'top';
      ctx.font = 'bold 14px sans-serif';
      ctx.textAlign = 'center';
      ctx.fillText('SCOREBOARD', 0, -tabulaHeight + 8);

      const team1 = 'Tým A';
      const team2 = 'Tým B';
      const score1 = 3;
      const score2 = teamBScore;

      ctx.font = 'bold 12px sans-serif';
      ctx.textAlign = 'left';
      ctx.fillText(team1, -tabulaWidth / 2 + 10, -tabulaHeight / 2);
      ctx.fillText(score1.toString(), -tabulaWidth / 2 + 25, -tabulaHeight / 2 + 16);

      ctx.textAlign = 'right';
      ctx.fillText(team2, tabulaWidth / 2 - 10, -tabulaHeight / 2);
      ctx.fillText(score2.toString(), -tabulaWidth / 2 - 25 + tabulaWidth, -tabulaHeight / 2 + 16);

      ctx.restore();
    }

    function drawBattersBoxes() {
      const boxWidth = 20;
      const boxHeight = 50;
      const spacing = 9;

      // Levý box (pro praváka)
      ctx.beginPath();
      ctx.rect(centerX - boxWidth - spacing, homePlateY - boxHeight / 2.5, boxWidth, boxHeight);
      ctx.fillStyle = '#ffcc80';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();

      // Pravý box (pro leváka)
      ctx.beginPath();
      ctx.rect(centerX + spacing, homePlateY - boxHeight / 2.5, boxWidth, boxHeight);
      ctx.fillStyle = '#ffcc80';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function drawCatcherBox() {
      const boxWidth = 17;
      const boxHeight = 30;
      const boxX = centerX - boxWidth / 2;
      const boxY = homePlateY + 0;  // těsně pod domácí metou

      ctx.beginPath();
      ctx.rect(boxX, boxY, boxWidth, boxHeight);
      ctx.fillStyle = '#ffcc80';
      ctx.fill();
      ctx.strokeStyle = 'white';
      ctx.lineWidth = 2;
      ctx.stroke();
    }

    function drawDugouts() {
      const dugoutWidth = 80;
      const dugoutHeight = 30;
      const roofHeight = 4;
      const benchHeight = 6;
      const poleWidth = 2;
      const offset = 80;

      const home = { x: centerX, y: homePlateY };

      // Pomocná funkce pro vykreslení jednoho dugoutu
      function drawSingleDugout(baseX, baseY, angle, flip = false) {
        ctx.save();
        ctx.translate(baseX, baseY);
        ctx.rotate(angle + (flip ? Math.PI : 0));

        // Střecha
        ctx.fillStyle = '#FFEA00';
        ctx.fillRect(-5, -roofHeight, dugoutWidth + 10, roofHeight);

        // Stěna dugoutu
        ctx.fillStyle = '#cfd8dc';
        ctx.fillRect(0, 0, dugoutWidth, dugoutHeight - roofHeight);

        // Sloupky
        ctx.fillStyle = '#212121';
        ctx.fillRect(2, 0, poleWidth, dugoutHeight - roofHeight);
        ctx.fillRect(dugoutWidth - 4, 0, poleWidth, dugoutHeight - roofHeight);

        // Lavice
        ctx.fillStyle = '#5d4037';
        ctx.fillRect(5, dugoutHeight - benchHeight - roofHeight - 1, dugoutWidth - 10, benchHeight);

        if (benchPlayerImg.complete) {
          const playerCount = 9;
          const spacing = (dugoutWidth - 20) / playerCount;

          for (let i = 0; i < playerCount; i++) {
            const x = 5 + i * spacing;
            const y = dugoutHeight - 24;
            const w = 15;
            const h = 20;

            ctx.save();
            ctx.translate(x + w / 2, y + h / 2);
            ctx.rotate(Math.PI);
            ctx.drawImage(benchPlayerImg, -w / 2, -h / 2, w, h);
            ctx.restore();
          }
        }

        ctx.restore();
      }

      // Levý dugout – 3B strana
      const angleLeft = Math.PI * 1.25;
      const leftX = home.x + Math.cos(angleLeft) * 3 * offset;
      const leftY = home.y + Math.sin(angleLeft) * 1.5 * offset;
      drawSingleDugout(leftX, leftY, angleLeft, true);

      // Pravý dugout – 1B strana
      const angleRight = Math.PI * 1.75;
      const rightX = home.x + Math.cos(angleRight) * 2 * offset;
      const rightY = home.y + Math.sin(angleRight) * 0.5 * offset;
      drawSingleDugout(rightX, rightY, angleRight);
      
      dugoutLeftPos = { x: leftX, y: leftY };
      dugoutRightPos = { x: rightX, y: rightY };
    }

    function drawOnDeckCircle() {
      const radius = 10;
      const offsetX = 90;
      const offsetY = 5;
      
      const leftX = centerX - offsetX;
      const rightX = centerX + offsetX;
      const circleY = homePlateY - offsetY;

      // Levý kruh (tým A) – vedle 3. mety
      ctx.beginPath();
      ctx.arc(leftX, circleY, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'transparent';
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'white';
      ctx.stroke();

      // Pravý kruh – vedle 1. mety (Tým B)
      ctx.beginPath();
      ctx.arc(rightX, circleY, radius, 0, Math.PI * 2);
      ctx.fillStyle = 'transparent';
      ctx.fill();
      ctx.lineWidth = 2;
      ctx.strokeStyle = 'white';
      ctx.stroke();

      // --- vykreslení hráče v pravém kruhu ---
      if (!hideOnDeckDuringAnimation && currentOnDeckBatter) {
        if (currentOnDeckBatter.img && currentOnDeckBatter.img.complete) {
          ctx.drawImage(
            currentOnDeckBatter.img,
            rightX - playerSize / 2,
            circleY - playerSize / 2 - 5,
            playerSize,
            playerSize
          );

          ctx.font = "12px Arial";
          ctx.fillStyle = "black";
          ctx.textAlign = "center";
          ctx.fillText(currentOnDeckBatter.name, rightX, circleY - radius - 5);
        }
      }
    }

    function drawField() {
      drawOutfield();
      drawWarningTrack();
      drawFoulLines();
      drawTabula();
      drawBattersBoxes(); 
      drawCatcherBox(); 
      drawDiamond();
      drawDugouts();
      drawOnDeckCircle();
    }

    // --- Drag & drop logika ---

    let draggingPlayer = null;
    let offsetX = 0;
    let offsetY = 0;

    function isInsidePlayer(player, mx, my) {
      return mx >= player.x && mx <= player.x + playerSize &&
             my >= player.y && my <= player.y + playerSize;
    }

    canvas.addEventListener('mousedown', e => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      // Zkontrolovat hráče od konce pole (abychom chytili vrchní hráče)
      for (let i = players.length - 1; i >= 0; i--) {
        // Povolíme drag jen pro hráče, jejichž jméno začíná na "Polar"
        if (players[i].name.startsWith('Polar') && isInsidePlayer(players[i], mouseX, mouseY)) {
          draggingPlayer = players[i];
          offsetX = mouseX - draggingPlayer.x;
          offsetY = mouseY - draggingPlayer.y;
          break;
        }
      }
    });

    canvas.addEventListener('mousemove', e => {
      const rect = canvas.getBoundingClientRect();
      const mouseX = e.clientX - rect.left;
      const mouseY = e.clientY - rect.top;

      if (!draggingPlayer) {
        // Pokud hráče netaháme – jen kurzor
        let hoveringPolar = false;
        for (let i = players.length - 1; i >= 0; i--) {
          if (players[i].name.startsWith('Polar') && isInsidePlayer(players[i], mouseX, mouseY)) {
            hoveringPolar = true;
            break;
          }
        }
        canvas.style.cursor = hoveringPolar ? 'pointer' : 'default';
      } else {
        canvas.style.cursor = 'grabbing';

        let newX = mouseX - offsetX;
        let newY = mouseY - offsetY;

        // Výchozí souřadnice home plate
        const homeX = centerX;
        const homeY = homePlateY;

        // Výpočet úhlu mezi home plate a novou pozicí hráče
        const dx = newX + playerSize / 2 - homeX;
        const dy = newY + playerSize / 2 - homeY;
        const angle = Math.atan2(dy, dx); // směr od home

        const distance = Math.sqrt(dx * dx + dy * dy); // vzdálenost od home

        const foulLeftAngle = Math.PI * 1.25;  // 225°
        const foulRightAngle = Math.PI * 1.75; // 315°

        const maxDistance = 400 - playerSize; // max vzdálenost od home kvůli homerun zóně

        // Konverze do rozsahu -π až π pro porovnání úhlů
        let normalizedAngle = angle;
        if (angle < -Math.PI) normalizedAngle += 2 * Math.PI;
        if (angle > Math.PI) normalizedAngle -= 2 * Math.PI;

        // Ověření: uvnitř foul lines a pod homerun obloukem
        const withinFoulLines =
          normalizedAngle >= -Math.PI * 0.75 && normalizedAngle <= -Math.PI * 0.25;

        const withinHomerunZone = distance <= maxDistance;

        if (withinFoulLines && withinHomerunZone) {
          draggingPlayer.x = newX;
          draggingPlayer.y = newY;
          draw();
        }
      }
    });

    canvas.addEventListener('mouseup', e => {
      draggingPlayer = null;
    });

    canvas.addEventListener('mouseleave', e => {
      draggingPlayer = null;
    });

    // 3) (DOPORUČENO) Uprav drawBatters() – pálkař se VŽDY kreslí jako pálkař
    function drawBatters() {
      // aktuální pálkař u domácí mety (pokud zrovna neběží "walk" animace)
      if (!hideBatterDuringOnDeckAnimation && battersQueue.length > 0) {
        const batterName = battersQueue[0].name;
        const x = centerX - 33;
        const y = homePlateY - 15;

        // jméno
        if (!runScoredText) {
          ctx.font = "12px Arial";
          ctx.fillStyle = "black";
          ctx.textAlign = "center";
          ctx.fillText(batterName, x + playerSize / 2, y - 5);
        }

        // sprite pálkaře VŽDY z palkarImg (ne z objektu v battersQueue)
        if (palkarImg && palkarImg.complete) {
          ctx.save();
          ctx.translate(x + playerSize / 2, y + playerSize / 2);
          ctx.rotate(3 * Math.PI / 2);
          ctx.drawImage(palkarImg, -playerSize / 2, -playerSize / 2, playerSize, playerSize);
          ctx.restore();
        } else {
          ctx.fillStyle = 'blue';
          ctx.fillRect(x, y, playerSize, playerSize);
        }
      }
    }

    function draw() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      drawField();
      drawBall();
      drawSlider();

      // běžci na metách (pokud neběží animace)
      if (!runnersInMotion) {
        if (runnerOnFirstBase) drawRun(runnerOnFirstBase, POS.FIRST);
        if (runnerOnSecondBase) drawRun(runnerOnSecondBase, POS.SECOND);
        if (runnerOnThirdBase) drawRun(runnerOnThirdBase, POS.THIRD);
      }

      // --- Pickoff tlačítko 1B ---
      const pickoffBtn1B = document.getElementById("pickoffButton");
      if (runnerOnFirstBase) {
        pickoffBtn1B.style.display = "inline-block";
        pickoffBtn1B.style.left = (POS.FIRST.x - 20) + "px";
        pickoffBtn1B.style.top  = (POS.FIRST.y + 5) + "px";
      } else {
        pickoffBtn1B.style.display = "none";
      }

      // --- Pickoff tlačítko 2B ---
      const pickoffBtn2B = document.getElementById("pickoffButton2B");
      if (runnerOnSecondBase) {
        pickoffBtn2B.style.display = "inline-block";
        pickoffBtn2B.style.left = (POS.SECOND.x) + "px";
        pickoffBtn2B.style.top  = (POS.SECOND.y + 10) + "px";
      } else {
        pickoffBtn2B.style.display = "none";
      }

      // vykreslíme běžce jdoucí do dugoutu (animace)
      drawDugoutRunners();

      // vykreslení hráčů v poli
      players.forEach(p => {
          if (p.name === 'Palkar') {
            if (hideBatterDuringOnDeckAnimation) return;
          }

        let drawX = p.x;
        let drawY = p.y;

        // >>> NOVÉ: Polar hlídá první metu, pokud je tam běžec
        if (p.name === 'Polar_FirstBase' && runnerOnFirstBase) {
          // posuneme Polara o trochu nahoru a doleva od mety
          drawX = POS.FIRST.x - 15; 
          drawY = POS.FIRST.y - 5; 
        }

        if (p.img.complete) {
          ctx.save();
          const centerXimg = drawX + playerSize / 2;
          const centerYimg = drawY + playerSize / 2;
          ctx.translate(centerXimg, centerYimg);

          // --- ROTACE PODLE STAVU ---
          if (p.name === 'Polar_SecondBase') {
            if (p.state === "runningToBase") {
              ctx.rotate(Math.PI); // běh směrem k 2B
            } else if (p.state === "returning") {
              ctx.rotate(Math.PI / 4);  // běh zpět na pozici
            } else {
              ctx.rotate(0);            // stojí normálně
            }
          } else if (p.name === 'Catcher') {
            ctx.rotate(Math.PI / 1);
          } else if (p.name === 'Nadhazovac') {
            ctx.rotate(Math.PI / 2);
          } else {
            ctx.rotate(0);
          }

          ctx.drawImage(p.img, -playerSize / 2, -playerSize / 2, playerSize, playerSize);
          ctx.restore();
        } else {
          ctx.fillStyle = 'red';
          ctx.fillRect(drawX, drawY, playerSize, playerSize);
        }
      });

      drawBatters();
    }

    function drawRun(runner, pos) {
      const LEAD_OFFSET = 25; // velikost "leadu" v px

      // Pokud běžec má vlastní souřadnice (animace), použij je
      let centerX = (runner.x !== undefined) ? runner.x : pos.x + playerSize / 2;
      let centerY = (runner.y !== undefined) ? runner.y : pos.y + playerSize / 2;

      // posuny podle mety, pokud nepoužíváme animované souřadnice
      if (runner.x === undefined && pos === POS.FIRST) {
        centerX -= LEAD_OFFSET;
        centerY -= LEAD_OFFSET;
      }
      if (runner.x === undefined && pos === POS.SECOND) {
        centerX -= LEAD_OFFSET;
        centerY += LEAD_OFFSET;
      }
      if (runner.x === undefined && pos === POS.THIRD) {
        centerX += LEAD_OFFSET;
        centerY += LEAD_OFFSET;
      }

      // statické mety: směr jako při animaci
      let dx = 0, dy = 0;
      if (pos === POS.FIRST) { dx = 1; dy = 1; }
      if (pos === POS.SECOND) { dx = 1; dy = -1; }
      if (pos === POS.THIRD) { dx = -1; dy = -1; }
      if (pos === POS.HOME) { dx = 0; dy = -1; }

      const angle = Math.atan2(dy, dx);
      let extraRotation = 0;

      // >>> výběr obrázku podle stavu
      let imgToDraw = benchPlayerImg; 
      if (runner.state === "sliding") {
        imgToDraw = slideImg;
        extraRotation = 12.25 / Math.PI;   
      } else if (runner.state === "returning") {
        imgToDraw = bezecImg;
        extraRotation = Math.PI;
      } else if (runner.state === "lead") {
        imgToDraw = benchPlayerImg;
        extraRotation = 0;   
      }

      // vykreslení běžce
      ctx.save();
      ctx.translate(centerX, centerY);
      ctx.rotate(angle + extraRotation);
      ctx.drawImage(imgToDraw, -playerSize / 2, -playerSize / 2, playerSize, playerSize);
      ctx.restore();

      // jméno nad běžcem: použij střed bez rotacef 
      if (!runScoredText && runner.name) {
        ctx.font = "12px Arial";
        ctx.fillStyle = "black";
        ctx.textAlign = "center";
        ctx.fillText(runner.name, centerX, centerY - playerSize / 2 - 5);
      }

      drawRunScored();
    }

    // Po načtení všech obrázků nakreslit
    let loadedCount = 0;
    const images = [catcherImg, nadhazovacImg, palkarImg, polarImg, bezecImg, ballImg];
    images.forEach(img => {
      img.onload = () => {
        loadedCount++;
        if (loadedCount === images.length) {
          draw();
          gameLoop();
        }
      }
    });

  </script>
</body>
</html>
